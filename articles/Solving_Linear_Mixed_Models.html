<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solving Linear Mixed Models using LMMsolver • LMMsolver</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Solving Linear Mixed Models using LMMsolver">
<meta property="og:description" content="LMMsolver">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">LMMsolver</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    news
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    functions
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-seedling"></span>
     
    other packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://biometris.github.io/statgenSTA">statgenSTA</a>
    </li>
    <li>
      <a href="https://biometris.github.io/statgenGxE">statgenGxE</a>
    </li>
    <li>
      <a href="https://biometris.github.io/statgenGWAS">statgenGWAS</a>
    </li>
    <li>
      <a href="https://biometris.github.io/statgenHTP">statgenHTP</a>
    </li>
    <li>
      <a href="https://biometris.github.io/statgenIBD">statgenIBD</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/Biometris/LMMsolver">
    <span class="fa fa-github fa-lg fab"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Solving_Linear_Mixed_Models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Solving Linear Mixed Models using LMMsolver</h1>
            
            <h4 class="date">2021-10-26</h4>
      
      
      <div class="hidden name"><code>Solving_Linear_Mixed_Models.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">LMMsolver</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<div id="the-lmmsolver-package" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#the-lmmsolver-package" class="anchor"></a>The LMMsolver package</h1>
<p>The aim of the <code>LMMsolver</code> package is to provide an efficient and flexible system to estimate variance components using restricted maximum likelihood or REML <span class="citation">(Patterson and Thompson <a href="#ref-Patterson1971" role="doc-biblioref">1971</a>)</span>, for models where the mixed model equations are sparse. An example of an application is using splines to model spatial <span class="citation">(Rodríguez-Álvarez et al. <a href="#ref-Rodriguez-Alvarez2018" role="doc-biblioref">2018</a>; Boer, Piepho, and Williams <a href="#ref-Boer2020" role="doc-biblioref">2020</a>)</span> or temporal <span class="citation">(Bustos-Korts et al. <a href="#ref-Bustos-Korts2019" role="doc-biblioref">2019</a>)</span> trends. Another example is mixed model Quantitative Trait Locus (QTL) analysis for multiparental populations, allowing for heterogeneous residual variance and design matrices with Identity-By-Descent (IBD) probabilities <span class="citation">(Li et al. <a href="#ref-Li2021" role="doc-biblioref">2021</a>)</span>.</p>
<p>A Linear Mixed Model (LMM) has the form</p>
<p><span class="math display">\[
  y = X \beta + Z u + e, \quad u \sim N(0,G), \quad e \sim N(0,R) 
\]</span> where <span class="math inline">\(y\)</span> is a vector of observations, <span class="math inline">\(\beta\)</span> is a vector with the fixed effects, <span class="math inline">\(u\)</span> is a vector with the random effects, and <span class="math inline">\(e\)</span> a vector of random residuals. <span class="math inline">\(X\)</span> and <span class="math inline">\(Z\)</span> are design matrices.</p>
<p>The <code>LMMsolve</code> package can fit models where the matrices <span class="math inline">\(G^{-1}\)</span> and <span class="math inline">\(R^{-1}\)</span> are a linear combination of precision matrices <span class="math inline">\(Q_{G,i}\)</span> and <span class="math inline">\(Q_{R,i}\)</span>: <span class="math display">\[
  G^{-1} = \sum_{i} \psi_i Q_{G,i} \;, \quad   R^{-1} = \sum_{i} \phi_i Q_{R,i} 
\]</span> where the precision parameters <span class="math inline">\(\psi_i\)</span> and <span class="math inline">\(\phi_i\)</span> are estimated using REML. For most standard mixed models <span class="math inline">\(1/{\psi_i}\)</span> are the variance components and <span class="math inline">\(1/{\phi_i}\)</span> the residual variances. We use a formulation in terms of precision parameters to allow for non-standard mixed models using tensor product splines introduced in <span class="citation">Rodríguez-Álvarez et al. (<a href="#ref-Rodriguez-Alvarez2015" role="doc-biblioref">2015</a>)</span>.</p>
<p>If the matrices <span class="math inline">\(G^{-1}\)</span> and <span class="math inline">\(R^{-1}\)</span> are sparse, the mixed model equations can be solved using efficient sparse matrix algebra implemented in the <code>spam</code> package <span class="citation">(Furrer and Sain <a href="#ref-Furrer2010" role="doc-biblioref">2010</a>)</span>. To calculate the derivatives of the log-likelihood in an efficient way, the automatic differentiation of the Cholesky matrix <span class="citation">(Smith <a href="#ref-Smith1995" role="doc-biblioref">1995</a>)</span> was implemented in C++ using the <code>Rcpp</code> package <span class="citation">(Eddelbuettel and Balamuta <a href="#ref-Eddelbuettel2018" role="doc-biblioref">2018</a>)</span>.</p>
</div>
<div id="smooth-trend-in-one-dimension-" class="section level1">
<h1 class="hasAnchor">
<a href="#smooth-trend-in-one-dimension-" class="anchor"></a>Smooth trend in one dimension.</h1>
<div id="oats-field-trial" class="section level2">
<h2 class="hasAnchor">
<a href="#oats-field-trial" class="anchor"></a>Oats field trial</h2>
<p>As a first example we will use an oats field trial from the <code>agridat</code> package. There were 24 varieties in 3 replicates, each consisting of 6 incomplete blocks of 4 plots. The plots were laid out in a single row.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load data.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">john.alpha</span>, package <span class="op">=</span> <span class="st">"agridat"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">john.alpha</span><span class="op">)</span>
<span class="co">#&gt;   plot rep block gen  yield</span>
<span class="co">#&gt; 1    1  R1    B1 G11 4.1172</span>
<span class="co">#&gt; 2    2  R1    B1 G04 4.4461</span>
<span class="co">#&gt; 3    3  R1    B1 G05 5.8757</span>
<span class="co">#&gt; 4    4  R1    B1 G22 4.5784</span>
<span class="co">#&gt; 5    5  R1    B2 G21 4.6540</span>
<span class="co">#&gt; 6    6  R1    B2 G10 4.1736</span></code></pre></div>
<p>In the following subsections we will use two methods to correct for spatial trend, to show some of the options of the package.</p>
<div id="modelling-spatial-trend-using-p-splines" class="section level3">
<h3 class="hasAnchor">
<a href="#modelling-spatial-trend-using-p-splines" class="anchor"></a>Modelling spatial trend using P-splines</h3>
<p>In this subsection we will illustrate how the package can be used to fit mixed model P-splines, for details see <span class="citation">Boer, Piepho, and Williams (<a href="#ref-Boer2020" role="doc-biblioref">2020</a>)</span>.</p>
<p>In the following mixed model we include rep and gen as fixed effect, and we use <code>spl1D</code> to model a one dimensional P-spline <span class="citation">(Eilers and Marx <a href="#ref-Eilers1996" role="doc-biblioref">1996</a>)</span> with 100 segments, and the default choice of cubical B-splines and second order differences:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Fit mixed model with fixed and spline part.</span>
<span class="va">obj1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LMMsolve.html">LMMsolve</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">yield</span> <span class="op">~</span> <span class="va">rep</span> <span class="op">+</span> <span class="va">gen</span>,
                 spline <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/spl1D.html">spl1D</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">plot</span>, nseg <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,
                 data <span class="op">=</span> <span class="va">john.alpha</span><span class="op">)</span></code></pre></div>
<p>A high number of segments can be used for splines in one dimension, as the corresponding mixed model equations are sparse, and therefore can be solved fast <span class="citation">(Smith <a href="#ref-Smith1995" role="doc-biblioref">1995</a>; Furrer and Sain <a href="#ref-Furrer2010" role="doc-biblioref">2010</a>)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/deviance.html">deviance</a></span><span class="op">(</span><span class="va">obj1</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 49.87</span></code></pre></div>
<p>We can obtain a table with effective dimensions (see e.g. <span class="citation">Rodríguez-Álvarez et al. (<a href="#ref-Rodriguez-Alvarez2018" role="doc-biblioref">2018</a>)</span>) and penalties (the precision parameters <span class="math inline">\(\psi_i\)</span> and <span class="math inline">\(\phi_i\)</span>) using the <code>summary</code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">obj1</span><span class="op">)</span>
<span class="co">#&gt; Table with effective dimensions and penalties: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;          Term Effective Model Nominal      Ratio    Penalty</span>
<span class="co">#&gt; 1 (Intercept)  1.000000     1       1 1.00000000    0.00000</span>
<span class="co">#&gt; 2         rep  2.000000     2       2 1.00000000    0.00000</span>
<span class="co">#&gt; 3         gen 23.000000    23      23 1.00000000    0.00000</span>
<span class="co">#&gt; 4        splF  1.000000     1       1 1.00000000    0.00000</span>
<span class="co">#&gt; 5     s(plot)  4.181297   103      45 0.09291771 9588.61061</span>
<span class="co">#&gt; 6    residual 40.818703    72      45 0.90708229   13.28288</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Total Effective Dimension: 72</span></code></pre></div>
<p>The effective dimension gives a good balance between model complexity and fit to the data for the random terms in the model. In the table above the first four terms are fixed effects and not penalized, and therefore the effective dimension is equal to the number of parameters in the model. The <code>splF</code> is the fixed part of the spline, the linear trend. The term <code>s(plot)</code> is a random effect, with effective dimension 4.2, indicating that is important to correct for spatial trend.</p>
<p>The estimated genetic effects are given by the <code>coef</code> function:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">genEff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">obj1</span><span class="op">)</span><span class="op">$</span><span class="va">gen</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">genEff</span>, <span class="fl">4</span><span class="op">)</span>
<span class="co">#&gt;    gen_G01    gen_G02    gen_G03    gen_G04 </span>
<span class="co">#&gt;  0.0000000 -0.5699756 -1.5231789 -0.4593992</span></code></pre></div>
<p>The first genotype (G01) is the reference, as genotypes were modelled as fixed effect in the model.</p>
<p>The smooth trend along the field on a dense grid of 1000 points can be obtained as follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Extract smooth trend from mixed model.</span>
<span class="va">plotDat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/obtainSmoothTrend.html">obtainSmoothTrend</a></span><span class="op">(</span><span class="va">obj1</span>, grid <span class="op">=</span> <span class="fl">1000</span>, includeIntercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">plotDat1</span><span class="op">)</span>
<span class="co">#&gt;       plot    ypred</span>
<span class="co">#&gt; 1 1.000000 5.036391</span>
<span class="co">#&gt; 2 1.071071 5.035374</span>
<span class="co">#&gt; 3 1.142142 5.034355</span>
<span class="co">#&gt; 4 1.213213 5.033335</span>
<span class="co">#&gt; 5 1.284284 5.032314</span>
<span class="co">#&gt; 6 1.355355 5.031290</span></code></pre></div>
<p>The trend can then be plotted.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Plot smooth trend.</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plotDat1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">plot</span>, y <span class="op">=</span> <span class="va">ypred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Smooth spatial trend oats data"</span>, x <span class="op">=</span> <span class="st">"plotnr"</span>, y <span class="op">=</span> <span class="st">"yield"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Solving_Linear_Mixed_Models_files/figure-html/plot1D-1.png" width="672"></p>
</div>
<div id="modelling-spatial-trend-using-random-and-ginverse-arguments-" class="section level3">
<h3 class="hasAnchor">
<a href="#modelling-spatial-trend-using-random-and-ginverse-arguments-" class="anchor"></a>Modelling spatial trend using <code>random</code> and <code>ginverse</code> arguments.</h3>
<p>Another way to correct for spatial trend is using the Linear Variance (LV) model, which is closely connected to the P-splines model <span class="citation">(Boer, Piepho, and Williams <a href="#ref-Boer2020" role="doc-biblioref">2020</a>)</span>. First we need to define the precision matrix for the LV model, see Appendix in <span class="citation">Boer, Piepho, and Williams (<a href="#ref-Boer2020" role="doc-biblioref">2020</a>)</span> for details:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## add plot as factor</span>
<span class="va">john.alpha</span><span class="op">$</span><span class="va">plotF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">john.alpha</span><span class="op">$</span><span class="va">plot</span><span class="op">)</span>
<span class="co">## define the precision matrix, see eq. A1 in Boer et al (2020):</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">john.alpha</span><span class="op">)</span>
<span class="va">cN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, diff <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">Delta</span> <span class="op">&lt;-</span> <span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span>
<span class="va">LVinv</span> <span class="op">&lt;-</span> <span class="fl">0.5</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">Delta</span> <span class="op">+</span> <span class="va">cN</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">cN</span><span class="op">)</span><span class="op">)</span>
<span class="co">## add LVinv to list, with name corresponding to random term:</span>
<span class="va">lGinv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>plotF<span class="op">=</span><span class="va">LVinv</span><span class="op">)</span></code></pre></div>
<p>Given the precision matrix for the LV model we can define the model in LMMsolve using the <code>random</code> and <code>ginverse</code> arguments:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Fit mixed model with first degree B-splines and first order differences.</span>
<span class="va">obj2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LMMsolve.html">LMMsolve</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">yield</span> <span class="op">~</span> <span class="va">rep</span> <span class="op">+</span> <span class="va">gen</span>,
                 random <span class="op">=</span> <span class="op">~</span><span class="va">plotF</span>, 
                 ginverse <span class="op">=</span> <span class="va">lGinv</span>, 
                 data <span class="op">=</span> <span class="va">john.alpha</span><span class="op">)</span></code></pre></div>
<p>The deviance for the LV-model is 54.49 and the variances</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">obj1</span>, which <span class="op">=</span> <span class="st">"variances"</span><span class="op">)</span>
<span class="co">#&gt; Table with variances: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;    VarComp     Variance</span>
<span class="co">#&gt; 1     splR 0.0001042904</span>
<span class="co">#&gt; 2 residual 0.0752848705</span></code></pre></div>
<p>as reported <span class="citation">Boer, Piepho, and Williams (<a href="#ref-Boer2020" role="doc-biblioref">2020</a>)</span>, Table 1.</p>
</div>
</div>
<div id="model-biomass-as-function-of-time-" class="section level2">
<h2 class="hasAnchor">
<a href="#model-biomass-as-function-of-time-" class="anchor"></a>Model biomass as function of time.</h2>
<p>In this section we show an example of mixed model P-splines to fit biomass as function of time. As an example we use wheat data simulated with the crop growth model APSIM. This data set is included in the package. For details on this simulated data see <span class="citation">Bustos-Korts et al. (<a href="#ref-Bustos-Korts2019" role="doc-biblioref">2019</a>)</span>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">APSIMdat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">APSIMdat</span><span class="op">)</span>
<span class="co">#&gt;            env geno das   biomass</span>
<span class="co">#&gt; 1 Emerald_1993 g001  20  65.57075</span>
<span class="co">#&gt; 2 Emerald_1993 g001  21  60.70499</span>
<span class="co">#&gt; 3 Emerald_1993 g001  22  74.06247</span>
<span class="co">#&gt; 4 Emerald_1993 g001  23  63.73951</span>
<span class="co">#&gt; 5 Emerald_1993 g001  24 101.88005</span>
<span class="co">#&gt; 6 Emerald_1993 g001  25  96.84971</span></code></pre></div>
<p>The first column is the environment, Emerald in 1993, the second column the simulated genotype (g001), the third column is days after sowing (das), and the last column is the simulated biomass with medium measurement error.</p>
<p>The model can be fitted with</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LMMsolve.html">LMMsolve</a></span><span class="op">(</span><span class="va">biomass</span> <span class="op">~</span> <span class="fl">1</span>,
                 spline <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/spl1D.html">spl1D</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">das</span>, nseg <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>, 
                 data <span class="op">=</span> <span class="va">APSIMdat</span><span class="op">)</span></code></pre></div>
<p>The effective dimensions are:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">obj2</span><span class="op">)</span>
<span class="co">#&gt; Table with effective dimensions and penalties: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;          Term  Effective Model Nominal      Ratio      Penalty</span>
<span class="co">#&gt; 1 (Intercept)   1.000000     1       1 1.00000000 0.000000e+00</span>
<span class="co">#&gt; 2        splF   1.000000     1       1 1.00000000 0.000000e+00</span>
<span class="co">#&gt; 3      s(das)   6.556916   203     119 0.05510013 4.738743e-02</span>
<span class="co">#&gt; 4    residual 112.443084   121     119 0.94489987 1.003077e-05</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Total Effective Dimension: 121</span></code></pre></div>
<p>The fitted smooth trend can be obtained as explained before:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plotDat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/obtainSmoothTrend.html">obtainSmoothTrend</a></span><span class="op">(</span><span class="va">obj2</span>, grid <span class="op">=</span> <span class="fl">1000</span>, includeIntercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">APSIMdat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">das</span>, y <span class="op">=</span> <span class="va">biomass</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plotDat2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ypred</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"APSIM biomass as function of time"</span>, 
       x <span class="op">=</span> <span class="st">"days after sowing"</span>, y <span class="op">=</span> <span class="st">"biomass (kg)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Solving_Linear_Mixed_Models_files/figure-html/APSIMplot-1.png" width="672"></p>
<p>The growth rate (first derivative) as function of time can be obtained using <code>deriv = 1</code> in function <code>obtainSmoothTrend</code>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plotDatDt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/obtainSmoothTrend.html">obtainSmoothTrend</a></span><span class="op">(</span><span class="va">obj2</span>, grid <span class="op">=</span> <span class="fl">1000</span>, deriv <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plotDatDt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">das</span>, y <span class="op">=</span> <span class="va">ypred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"APSIM growth rate as function of time"</span>, 
       x <span class="op">=</span> <span class="st">"days after sowing"</span>, y <span class="op">=</span> <span class="st">"growth rate (kg/day)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Solving_Linear_Mixed_Models_files/figure-html/APSIMDeriv-1.png" width="672"></p>
</div>
</div>
<div id="smooth-trends-in-two-dimensions" class="section level1">
<h1 class="hasAnchor">
<a href="#smooth-trends-in-two-dimensions" class="anchor"></a>Smooth trends in two dimensions</h1>
<p>For two-dimensional mixed P-splines we use the model defined in <span class="citation">Rodríguez-Álvarez et al. (<a href="#ref-Rodriguez-Alvarez2015" role="doc-biblioref">2015</a>)</span>. As an example we use the <code>USprecip</code> data set in the <code>spam</code> package <span class="citation">(Furrer and Sain <a href="#ref-Furrer2010" role="doc-biblioref">2010</a>)</span>, analysed in <span class="citation">Rodríguez-Álvarez et al. (<a href="#ref-Rodriguez-Alvarez2015" role="doc-biblioref">2015</a>)</span>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Get precipitation data from spam</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">USprecip</span>, package <span class="op">=</span> <span class="st">"spam"</span><span class="op">)</span>

<span class="co">## Only use observed data</span>
<span class="va">USprecip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">USprecip</span><span class="op">)</span>
<span class="va">USprecip</span> <span class="op">&lt;-</span> <span class="va">USprecip</span><span class="op">[</span><span class="va">USprecip</span><span class="op">$</span><span class="va">infill</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span></code></pre></div>
<p>The two-dimensional P-spline can be defined with the <code><a href="../reference/spl1D.html">spl2D()</a></code> function, and with longitude and latitude as covariates. The number of segments chosen here is equal to the number of segments used in <span class="citation">Rodríguez-Álvarez et al. (<a href="#ref-Rodriguez-Alvarez2015" role="doc-biblioref">2015</a>)</span>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obj3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LMMsolve.html">LMMsolve</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">anomaly</span> <span class="op">~</span> <span class="fl">1</span>,
                 spline <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/spl1D.html">spl2D</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="va">lon</span>, x2 <span class="op">=</span> <span class="va">lat</span>, nseg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">41</span>, <span class="fl">41</span><span class="op">)</span><span class="op">)</span>,
                 data <span class="op">=</span> <span class="va">USprecip</span><span class="op">)</span></code></pre></div>
<p>The summary function gives a table with the effective dimensions and the penalty parameters:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">obj3</span><span class="op">)</span>
<span class="co">#&gt; Table with effective dimensions and penalties: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt;          Term Effective Model Nominal     Ratio     Penalty</span>
<span class="co">#&gt; 1 (Intercept)    1.0000     1       1 1.0000000  0.00000000</span>
<span class="co">#&gt; 2        splF    3.0000     3       3 1.0000000  0.00000000</span>
<span class="co">#&gt; 3      s(lon)  302.6004  1936    1932 0.1566255  0.09679905</span>
<span class="co">#&gt; 4      s(lat)  409.0868  1936    1932 0.2117426  0.36223681</span>
<span class="co">#&gt; 5    residual 5190.3128  5906    5902 0.8794159 13.52577270</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;  Total Effective Dimension: 5906</span></code></pre></div>
<p>A plot for the smooth trend can be obtained in a similar way as for the one-dimensional examples:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plotDat3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/obtainSmoothTrend.html">obtainSmoothTrend</a></span><span class="op">(</span><span class="va">obj3</span>, grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span>, includeIntercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">usa</span> <span class="op">=</span> <span class="fu">maps</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html">map</a></span><span class="op">(</span><span class="st">"usa"</span>, regions <span class="op">=</span> <span class="st">"main"</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html">point.in.polygon</a></span><span class="op">(</span><span class="va">plotDat3</span><span class="op">$</span><span class="va">lon</span>, <span class="va">plotDat3</span><span class="op">$</span><span class="va">lat</span>, <span class="va">usa</span><span class="op">$</span><span class="va">x</span>, <span class="va">usa</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="va">plotDat3</span> <span class="op">&lt;-</span> <span class="va">plotDat3</span><span class="op">[</span><span class="va">v</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plotDat3</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span>, fill <span class="op">=</span> <span class="va">ypred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">topo.colors</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Precipitation (anomaly)"</span>, x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="Solving_Linear_Mixed_Models_files/figure-html/Plot_USprecip-1.png" width="672"></p>
<p>Instead of using the <code>grid</code> argument, <code>newdata</code> can be used to make predictions for locations specified in a <code>data.frame</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Predictions for new data, using city coordinates from maps package.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">us.cities</span>, package <span class="op">=</span> <span class="st">"maps"</span><span class="op">)</span>
<span class="co">## Column names have to match column names used for fitting the model.</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">us.cities</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">us.cities</span><span class="op">)</span> <span class="op">==</span> <span class="st">"long"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"lon"</span>
<span class="co">## Select columns name, lat and lon</span>
<span class="va">us.cities</span> <span class="op">&lt;-</span> <span class="va">us.cities</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">us.cities</span><span class="op">)</span>
<span class="co">#&gt;         name   lat     lon</span>
<span class="co">#&gt; 1 Abilene TX 32.45  -99.74</span>
<span class="co">#&gt; 2   Akron OH 41.08  -81.52</span>
<span class="co">#&gt; 3 Alameda CA 37.77 -122.26</span>
<span class="co">#&gt; 4  Albany GA 31.58  -84.18</span>
<span class="co">#&gt; 5  Albany NY 42.67  -73.80</span>
<span class="co">#&gt; 6  Albany OR 44.62 -123.09</span>

<span class="va">pred3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/obtainSmoothTrend.html">obtainSmoothTrend</a></span><span class="op">(</span><span class="va">obj3</span>, newdata <span class="op">=</span> <span class="va">us.cities</span>, includeIntercept <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pred3</span><span class="op">)</span>
<span class="co">#&gt;         name   lat     lon       ypred</span>
<span class="co">#&gt; 1 Abilene TX 32.45  -99.74 -0.50934296</span>
<span class="co">#&gt; 2   Akron OH 41.08  -81.52  1.04632673</span>
<span class="co">#&gt; 3 Alameda CA 37.77 -122.26  1.15536050</span>
<span class="co">#&gt; 4  Albany GA 31.58  -84.18  1.00461677</span>
<span class="co">#&gt; 5  Albany NY 42.67  -73.80  0.09537157</span>
<span class="co">#&gt; 6  Albany OR 44.62 -123.09  0.79867839</span></code></pre></div>
</div>
<div id="qtl-mapping-with-ibd-probabilities-" class="section level1">
<h1 class="hasAnchor">
<a href="#qtl-mapping-with-ibd-probabilities-" class="anchor"></a>QTL mapping with IBD probabilities.</h1>
<p>In QTL-mapping for multiparental populations the Identity-By-Descent (IBD) probabilities are used as genetic predictors in the mixed model <span class="citation">(Li et al. <a href="#ref-Li2021" role="doc-biblioref">2021</a>)</span>. The following simulated example is for illustration. It consists of three parents (A, B, and C), and two crosses AxB, and AxC. AxB is a population of 100 Doubled Haploids (DH), AxC of 80 DHs. The probabilities, pA, pB, and pC, are for a position on the genome close to a simulated QTL. This simulated data is included in the package.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Load data for multiparental population.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">multipop</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">multipop</span><span class="op">)</span>
<span class="co">#&gt;   cross     ind         pA         pB pC    pheno</span>
<span class="co">#&gt; 1   AxB AxB0001 0.17258816 0.82741184  0 9.890637</span>
<span class="co">#&gt; 2   AxB AxB0002 0.82170793 0.17829207  0 6.546568</span>
<span class="co">#&gt; 3   AxB AxB0003 0.95968439 0.04031561  0 7.899249</span>
<span class="co">#&gt; 4   AxB AxB0004 0.96564081 0.03435919  0 4.462866</span>
<span class="co">#&gt; 5   AxB AxB0005 0.04838734 0.95161266  0 5.207757</span>
<span class="co">#&gt; 6   AxB AxB0006 0.95968439 0.04031561  0 5.265580</span></code></pre></div>
<p>The residual (genetic) variances for the two populations can be different. Therefore we need to allow for heterogeneous residual variances, which can be defined by using the <code>residual</code> argument in <code>LMMsolve</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Fit null model.</span>
<span class="va">obj4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LMMsolve.html">LMMsolve</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">pheno</span> <span class="op">~</span> <span class="va">cross</span>, 
                 residual <span class="op">=</span> <span class="op">~</span><span class="va">cross</span>, 
                 data <span class="op">=</span> <span class="va">multipop</span><span class="op">)</span>
<span class="va">dev4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/deviance.html">deviance</a></span><span class="op">(</span><span class="va">obj4</span><span class="op">)</span></code></pre></div>
<p>The QTL-probabilities are defined by the columns pA, pB, pC, and can be included in the random part of the mixed model by using the <code>group</code> argument:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Fit alternative model - include QTL with probabilities defined in columns 3:5 </span>
<span class="va">lGrp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>QTL <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">obj5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LMMsolve.html">LMMsolve</a></span><span class="op">(</span>fixed <span class="op">=</span> <span class="va">pheno</span> <span class="op">~</span> <span class="va">cross</span>, 
                 group <span class="op">=</span> <span class="va">lGrp</span>,
                 random <span class="op">=</span> <span class="op">~</span><span class="fu">grp</span><span class="op">(</span><span class="va">QTL</span><span class="op">)</span>,
                 residual <span class="op">=</span> <span class="op">~</span><span class="va">cross</span>,
                 data <span class="op">=</span> <span class="va">multipop</span><span class="op">)</span> 
<span class="va">dev5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/deviance.html">deviance</a></span><span class="op">(</span><span class="va">obj5</span><span class="op">)</span></code></pre></div>
<p>The approximate <span class="math inline">\(-log10(p)\)</span> value is given by</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Deviance difference between null and alternative model.</span>
<span class="va">dev</span> <span class="op">&lt;-</span> <span class="va">dev4</span> <span class="op">-</span> <span class="va">dev5</span>
<span class="co">## Calculate approximate p-value </span>
<span class="va">minlog10p</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">dev</span>, <span class="fl">1</span>, lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">minlog10p</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 8.76</span></code></pre></div>
<p>The estimated QTL effects of the parents A, B, and C are given by:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">obj5</span><span class="op">)</span><span class="op">$</span><span class="va">QTL</span>
<span class="co">#&gt;     QTL_pA     QTL_pB     QTL_pC </span>
<span class="co">#&gt; -1.2676362  0.6829275  0.5847088</span></code></pre></div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Boer2020">
<p>Boer, Martin P., Hans Peter Piepho, and Emlyn R. Williams. 2020. “Linear Variance, P-splines and Neighbour Differences for Spatial Adjustment in Field Trials: How are they Related?” <em>J. Agric. Biol. Environ. Stat.</em> 25 (4): 676–98. <a href="https://doi.org/10.1007/S13253-020-00412-4">https://doi.org/10.1007/S13253-020-00412-4</a>.</p>
</div>
<div id="ref-Bustos-Korts2019">
<p>Bustos-Korts, Daniela, Martin P. Boer, Marcos Malosetti, Scott Chapman, Karine Chenu, Bangyou Zheng, and Fred A. van Eeuwijk. 2019. “Combining Crop Growth Modeling and Statistical Genetic Modeling to Evaluate Phenotyping Strategies.” <em>Front. Plant Sci.</em> 10 (November). <a href="https://doi.org/10.3389/FPLS.2019.01491/FULL">https://doi.org/10.3389/FPLS.2019.01491/FULL</a>.</p>
</div>
<div id="ref-Eddelbuettel2018">
<p>Eddelbuettel, Dirk, and James Joseph Balamuta. 2018. “Extending extitR with extitC++: A Brief Introduction to extitRcpp.” <em>The American Statistician</em> 72 (1): 28–36. <a href="https://doi.org/10.1080/00031305.2017.1375990">https://doi.org/10.1080/00031305.2017.1375990</a>.</p>
</div>
<div id="ref-Eilers1996">
<p>Eilers, PHC, and BD Marx. 1996. “Flexible smoothing with B-splines and penalties.” <em>Stat. Sci.</em> <a href="http://www.jstor.org/stable/2246049">http://www.jstor.org/stable/2246049</a>.</p>
</div>
<div id="ref-Furrer2010">
<p>Furrer, R, and SR Sain. 2010. “spam: A sparse matrix R package with emphasis on MCMC methods for Gaussian Markov random fields.” <em>J. Stat. Softw.</em> <a href="http://core.kmi.open.ac.uk/download/pdf/6340272.pdf">http://core.kmi.open.ac.uk/download/pdf/6340272.pdf</a>.</p>
</div>
<div id="ref-Li2021">
<p>Li, Wenhao, Martin P. Boer, Chaozhi Zheng, Ronny V. L. Joosen, and Fred A. van Eeuwijk. 2021. “An IBD-based mixed model approach for QTL mapping in multiparental populations.” <em>Theor. Appl. Genet. 2021</em> 1 (August): 1–18. <a href="https://doi.org/10.1007/S00122-021-03919-7">https://doi.org/10.1007/S00122-021-03919-7</a>.</p>
</div>
<div id="ref-Patterson1971">
<p>Patterson, HD, and R Thompson. 1971. “Recovery of inter-block information when block sizes are unequal.” <em>Biometrika</em>. <a href="http://biomet.oxfordjournals.org/content/58/3/545.short">http://biomet.oxfordjournals.org/content/58/3/545.short</a>.</p>
</div>
<div id="ref-Rodriguez-Alvarez2018">
<p>Rodríguez-Álvarez, María Xosé, Martin P. Boer, Fred A. van Eeuwijk, and Paul H. C. Eilers. 2018. “Correcting for spatial heterogeneity in plant breeding experiments with P-splines.” <em>Spat. Stat.</em> 23 (March): 52–71. <a href="https://doi.org/10.1016/J.SPASTA.2017.10.003">https://doi.org/10.1016/J.SPASTA.2017.10.003</a>.</p>
</div>
<div id="ref-Rodriguez-Alvarez2015">
<p>Rodríguez-Álvarez, María Xosé, Dae Jin Lee, Thomas Kneib, María Durbán, and Paul Eilers. 2015. “Fast smoothing parameter separation in multidimensional generalized P-splines: the SAP algorithm.” <em>Stat. Comput.</em> 25 (5): 941–57. <a href="https://doi.org/10.1007/S11222-014-9464-2">https://doi.org/10.1007/S11222-014-9464-2</a>.</p>
</div>
<div id="ref-Smith1995">
<p>Smith, S. P. 1995. “Differentiation of the Cholesky Algorithm.” <em>J. Comput. Graph. Stat.</em> 4 (2): 134. <a href="http://www.jstor.org/stable/1390762?origin=crossref">http://www.jstor.org/stable/1390762?origin=crossref</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Martin Boer, Bart-Jan van Rossum.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
